from os.path import exists
from os import mkdir

from requests import get
from dataclasses import dataclass
from rich.console import Console

from logger import Logger, banner
from random_user_agent import random_user_agent


@dataclass
class ExploitInfo:
    Platform : str
    PublishDate : str
    Type : str
    ExploitDBID : int
    Author : str
    Metasploit : bool
    Verified : bool
    Link : str


def GetExploitInfo(CVEID):
    try:
        apiresponse = get(
            f"https://www.exploit-db.com/search?cve={CVEID}",
            headers={
                "X-Requested-With": "XMLHttpRequest",
                "User-Agent": next(random_user_agent())
            }
        )
    except ConnectionError:
        return []
    else:
        apidata = apiresponse.json()
        ExploitInfos = []
        for exploit in apidata['data']:
            Exploit = ExploitInfo(
                Platform=exploit['platform_id'],
                PublishDate=exploit['date_published'],
                Type=exploit['type_id'],
                ExploitDBID=int(exploit['id']),
                Author=exploit['author']['name'],
                Metasploit=exploit['author']['name'] == "Metasploit",
                Verified=exploit['verified'] == "1",
                Link=f"https://www.exploit-db.com/download/{exploit['id']}"
            )
            ExploitInfos.append(Exploit)

        return ExploitInfos


def GetExploitContents(ExploitLink):
    try:
        apiresponse = get(
            ExploitLink,
            headers={
                "X-Requested-With": "XMLHttpRequest",
                "User-Agent": next(random_user_agent())
            }
        )
        content = apiresponse.content
        filename = apiresponse.headers['Content-Disposition'].lstrip(
                "attachment; filename=\""
            )
    except ConnectionError:
        return None, None
    else:
        return content, filename


def GetExploitAsFile(vulnerability):
    console = Console()

    SoftwareName = vulnerability.Software
    CVEs = vulnerability.CVEs

    if not exists("exploits"):
        mkdir("exploits")

    printed_software = []
    for CVE in CVEs:
        Exploits = GetExploitInfo(CVE)
        if not len(Exploits) > 0:
            continue

        if not SoftwareName in printed_software:
            console.print(f"\n\n┌─[yellow][{SoftwareName}][/yellow]\n│")
            printed_software.append(SoftwareName)

        console.print(f"│\n├─────┤ [red]{str(CVE)}[/red]\n│")

        for exploit in Exploits:
            print(
                f"Downloading exploit for {SoftwareName} ({CVE})...", end="\r"
            )
            content, filename = GetExploitContents(exploit.Link)
            if content is None:
                continue

            if not exists(f"exploits/{SoftwareName}"):
                mkdir(f"exploits/{SoftwareName}")

            if not exists(f"exploits/{SoftwareName}/{CVE}"):
                mkdir(f"exploits/{SoftwareName}/{CVE}")

            with open("exploits/" + SoftwareName + "/" + CVE + "/" + filename, "wb") as exploitfile:
                print(" " * 100, end="\r") #clear the line
                console.print(
                    f"├──────────# exploits/{SoftwareName}/{CVE}/{filename}\n│"
                    + f"│\t\t [cyan]Platform: [/cyan] {exploit.Platform}\n"
                    + f"│\t\t [cyan]Type: [/cyan] {exploit.Type}\n"
                    + f"│\t\t [cyan]Author: [/cyan] {exploit.Author}\n"
                    + f"│\t\t [cyan]Date: [/cyan] {exploit.PublishDate}\n"
                    + f"│\t\t [cyan]Metasploit: [/cyan] {str(exploit.Metasploit)}\n"
                    + f"│\t\t [cyan]Verified: [/cyan]{str(exploit.Verified)}"
                    + f"│\t\t [cyan]Link: [/cyan] {exploit.Link}\n│"
                )
                exploitfile.write(content)

    if SoftwareName in printed_software:
        print(" " * 100, end="\r")
        print("└" + "─" * 59 + "\n")


def GetExploitsFromArray(VulnsArray, target=None):
    console = Console()

    if target:
        console.print(f"Downloading exploits for {target}...", style="blue")
    else:
        console.print(f"Downloading exploits...", style="blue")

    for vulnerability in VulnsArray:
        GetExploitAsFile(vulnerability)
